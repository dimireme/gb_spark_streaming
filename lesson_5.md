## Урок 5. Spark Streaming. Stateful streams.

##### Задание 1. Запустить агрегацию по временному окну в разных режимах.

1\.1\. Подключаемся к серверу

```bash
ssh BD_274_ashadrin@89.208.223.141 -i ~/.ssh/id_rsa_gb_spark
```


1\.2\. Запускаем `pyspark`. 

```bash
[BD_274_ashadrin@bigdataanalytics-worker-0 ~]$ export SPARK_KAFKA_VERSION=0.10
[BD_274_ashadrin@bigdataanalytics-worker-0 ~]$ /spark2.4/bin/pyspark --packages org.apache.spark:spark-sql-kafka-0-10_2.11:2.4.5 --driver-memory 512m --master local[1]
```

1\.3\. Прочитаем топик `shadrin_iris`, вспомним что лежит в Кафке.

Далее делаем стандартные импорты и определяем константы, схему данных и сам стрим, который читает топик `shadrin_iris` из Кафки.

```python
from pyspark.sql import functions as F
from pyspark.sql.types import StructType, StringType, FloatType

kafka_brokers = "bigdataanalytics-worker-0.novalocal:6667"

raw_data = spark.readStream. \
    format("kafka"). \
    option("kafka.bootstrap.servers", kafka_brokers). \
    option("subscribe", "shadrin_iris"). \
    option("startingOffsets", "earliest"). \
    option("maxOffsetsPerTrigger", "6"). \
    load()

schema = StructType() \
    .add("sepalLength", FloatType()) \
    .add("sepalWidth", FloatType()) \
    .add("petalLength", FloatType()) \
    .add("petalWidth", FloatType()) \
    .add("species", StringType())
```
   
1\.4\. WATERMARK и дубликаты внутри одного батча.

Waterwark - одна из настроек стрима для сохранения состояния этого стрима внутри чекпойнта. Добавим колонку с временем обработки микробатча. Она понадобится для настройки чекпойнта и waterwark.
   
```python
extended_iris = raw_data \
    .select(F.from_json(F.col("value").cast("String"), schema).alias("value"), "offset") \
    .select("value.*", "offset") \
    .withColumn("receive_time", F.current_timestamp())

extended_iris.printSchema()
```

    root
     |-- sepalLength: float (nullable = true)
     |-- sepalWidth: float (nullable = true)
     |-- petalLength: float (nullable = true)
     |-- petalWidth: float (nullable = true)
     |-- species: string (nullable = true)
     |-- offset: long (nullable = true)
     |-- receive_time: timestamp (nullable = false)


В методе `console_output` обязательно указываем папку, в которой будет храниться чекпойнт. 

```python
def console_output(df, freq):
    return df.writeStream \
        .format("console") \
        .trigger(processingTime='%s seconds' % freq ) \
        .option("checkpointLocation", "checkpoints/duplicates_console_chk") \
        .options(truncate=False) \
        .start()
```

Запускаем стрим и смотрим как растёт наш чекпойнт (команда `hdfs dfs -du -h checkpoints/duplicates_console_chk`).

```python
stream = console_output(extended_iris , 5)
stream.stop()
```

Задаём waterwark, которая должна очищать чекпоинт. Первый параметр - назване колонки, на которую смотрит waterwark, второй параметр - гарантированное время жизни информации о сообщении в чекпойнте. Именно для этого мы добавляли столбец `receive_time`.

```python
waterwarked_iris = extended_iris.withWatermark("receive_time", "30 seconds")
waterwarked_iris.printSchema()
```

Схема не поменялась. Waterwark только следит за чекпойнтом, но никак не аффектит наши данные. 

Теперь данные можно проверить на наличие дубликатов. Дубли проверяем по двум колонкам: `species` и `receive_time`. Таким образом будут отсеиваться дубли по полю `species` внутри одного микробатча, так как столбец `receive_time` для всех записей внутри этого микробатча одинаковый. 

```python
deduplicated_iris = waterwarked_iris.drop_duplicates(["species", "receive_time"])
```

Чтобы всё заработало, нужно предварительно очистить чекпойнт (команда `hdfs dfs -rm -r checkpoints/duplicates_console_chk`).

```python
stream = console_output(deduplicated_iris , 20)
```
    -------------------------------------------                                     
    Batch: 7
    -------------------------------------------
    +-----------+----------+-----------+----------+-------+------+-----------------------+
    |sepalLength|sepalWidth|petalLength|petalWidth|species|offset|receive_time           |
    +-----------+----------+-----------+----------+-------+------+-----------------------+
    |4.4        |3.2       |1.3        |0.2       |setosa |42    |2020-12-23 22:28:00.003|
    +-----------+----------+-----------+----------+-------+------+-----------------------+
    
    -------------------------------------------                                     
    Batch: 8
    -------------------------------------------
    +-----------+----------+-----------+----------+----------+------+-----------------------+
    |sepalLength|sepalWidth|petalLength|petalWidth|species   |offset|receive_time           |
    +-----------+----------+-----------+----------+----------+------+-----------------------+
    |7.0        |3.2       |4.7        |1.4       |versicolor|50    |2020-12-23 22:28:20.003|
    |5.3        |3.7       |1.5        |0.2       |setosa    |48    |2020-12-23 22:28:20.003|
    +-----------+----------+-----------+----------+----------+------+-----------------------+
    
    -------------------------------------------                                     
    Batch: 9
    -------------------------------------------
    +-----------+----------+-----------+----------+----------+------+-----------------------+
    |sepalLength|sepalWidth|petalLength|petalWidth|species   |offset|receive_time           |
    +-----------+----------+-----------+----------+----------+------+-----------------------+
    |6.5        |2.8       |4.6        |1.5       |versicolor|54    |2020-12-23 22:28:40.005|
    +-----------+----------+-----------+----------+----------+------+-----------------------+


В каждом микробатче только записи с уникальным значением по колонке `species`.

```python
stream.stop()
```

Без указания в `drop_duplicates` столбца с временнОй меткой, дубликаты отсеивались бы по всем данным. И все эти данные хранились бы в чекпойнте, даже не смотря на то что у нас настроен waterwark. Чтобы не допустить раздувания чекпойнта, указывается столбец с временнОй меткой. Waterwark ограничивает "глубину" данных не только для поиска дубликатов, но и для любой группирующей функции. 

1\.5\. WINDOW и дубликаты за периоды времени.

На этом этапе я пересоздал топик `shadrin_iris` с перемешанными данными.

Создаём временное окно. В структуру датафрейма добавился новый столбец.

```python
windowed_iris = extended_iris.withColumn("window_time", F.window(F.col("receive_time"), "2 minute"))
windowed_iris.printSchema()
```

    root
     |-- sepalLength: float (nullable = true)
     |-- sepalWidth: float (nullable = true)
     |-- petalLength: float (nullable = true)
     |-- petalWidth: float (nullable = true)
     |-- species: string (nullable = true)
     |-- offset: long (nullable = true)
     |-- receive_time: timestamp (nullable = false)
     |-- window_time: struct (nullable = false)
     |    |-- start: timestamp (nullable = true)
     |    |-- end: timestamp (nullable = true)
    

Устанавливаем вотермарк для очистки чекпоинта и удаляем дубли в каждом окне.

```python
waterwarked_windowed_iris = windowed_iris.withWatermark("window_time", "1 minute")
deduplicated_windowed_iris = waterwarked_windowed_iris \
    .drop_duplicates(["species", "window_time"])
```

Проверяем как удаляются дубли из каждого окна.

```python
stream = console_output(deduplicated_windowed_iris , 20)
```

    -------------------------------------------                                     
    Batch: 0
    -------------------------------------------
    +-----------+----------+-----------+----------+----------+------+----------------------+------------------------------------------+
    |sepalLength|sepalWidth|petalLength|petalWidth|species   |offset|receive_time          |window_time                               |
    +-----------+----------+-----------+----------+----------+------+----------------------+------------------------------------------+
    |5.0        |3.0       |1.6        |0.2       |setosa    |2     |2020-12-24 02:03:02.34|[2020-12-24 02:02:00, 2020-12-24 02:04:00]|
    |6.3        |2.8       |5.1        |1.5       |virginica |0     |2020-12-24 02:03:02.34|[2020-12-24 02:02:00, 2020-12-24 02:04:00]|
    |6.3        |3.3       |4.7        |1.6       |versicolor|1     |2020-12-24 02:03:02.34|[2020-12-24 02:02:00, 2020-12-24 02:04:00]|
    +-----------+----------+-----------+----------+----------+------+----------------------+------------------------------------------+
    
    -------------------------------------------                                     
    Batch: 1
    -------------------------------------------
    +-----------+----------+-----------+----------+-------+------+------------+-----------+
    |sepalLength|sepalWidth|petalLength|petalWidth|species|offset|receive_time|window_time|
    +-----------+----------+-----------+----------+-------+------+------------+-----------+
    +-----------+----------+-----------+----------+-------+------+------------+-----------+
    
    -------------------------------------------                                     
    Batch: 2
    -------------------------------------------
    +-----------+----------+-----------+----------+-------+------+------------+-----------+
    |sepalLength|sepalWidth|petalLength|petalWidth|species|offset|receive_time|window_time|
    +-----------+----------+-----------+----------+-------+------+------------+-----------+
    +-----------+----------+-----------+----------+-------+------+------------+-----------+
    
    -------------------------------------------                                     
    Batch: 3
    -------------------------------------------
    +-----------+----------+-----------+----------+-------+------+------------+-----------+
    |sepalLength|sepalWidth|petalLength|petalWidth|species|offset|receive_time|window_time|
    +-----------+----------+-----------+----------+-------+------+------------+-----------+
    +-----------+----------+-----------+----------+-------+------+------------+-----------+
    
    -------------------------------------------                                     
    Batch: 4
    -------------------------------------------
    +-----------+----------+-----------+----------+----------+------+-----------------------+------------------------------------------+
    |sepalLength|sepalWidth|petalLength|petalWidth|species   |offset|receive_time           |window_time                               |
    +-----------+----------+-----------+----------+----------+------+-----------------------+------------------------------------------+
    |6.4        |2.8       |5.6        |2.2       |virginica |25    |2020-12-24 02:04:00.003|[2020-12-24 02:04:00, 2020-12-24 02:06:00]|
    |5.1        |3.8       |1.9        |0.4       |setosa    |26    |2020-12-24 02:04:00.003|[2020-12-24 02:04:00, 2020-12-24 02:06:00]|
    |5.5        |2.3       |4.0        |1.3       |versicolor|24    |2020-12-24 02:04:00.003|[2020-12-24 02:04:00, 2020-12-24 02:06:00]|
    +-----------+----------+-----------+----------+----------+------+-----------------------+------------------------------------------+


```python
stream.stop()
```

Видим что в рамках одного окна дубликатов нет.

1\.6\. SLIDING WINDOW

Аналогично предыдущему пункту создаём дополнительное поле `sliding_time`. В функции `F.window` первый аргумент это колонка (временная метка), по которой создаётся окно; второй аргумент - ширина окна; третий - сдвиг окна. Добавляем вотермарку и указываем колонки, по которым будем исключать дубли.

```python
sliding_iris = extended_iris.withColumn("sliding_time", F.window(F.col("receive_time"), "1 minute", "30 seconds"))
waterwarked_sliding_iris = sliding_iris.withWatermark("sliding_time", "2 minute")
deduplicated_sliding_iris = waterwarked_sliding_iris.drop_duplicates(["species", "sliding_time"])
stream = console_output(deduplicated_sliding_iris , 20)
```

    -------------------------------------------                                     
    Batch: 0
    -------------------------------------------
    +-----------+----------+-----------+----------+----------+------+-----------------------+------------------------------------------+
    |sepalLength|sepalWidth|petalLength|petalWidth|species   |offset|receive_time           |sliding_time                              |
    +-----------+----------+-----------+----------+----------+------+-----------------------+------------------------------------------+
    |5.0        |3.0       |1.6        |0.2       |setosa    |2     |2020-12-24 02:14:02.134|[2020-12-24 02:14:00, 2020-12-24 02:15:00]|
    |6.3        |2.8       |5.1        |1.5       |virginica |0     |2020-12-24 02:14:02.134|[2020-12-24 02:14:00, 2020-12-24 02:15:00]|
    |6.3        |3.3       |4.7        |1.6       |versicolor|1     |2020-12-24 02:14:02.134|[2020-12-24 02:14:00, 2020-12-24 02:15:00]|
    |6.3        |3.3       |4.7        |1.6       |versicolor|1     |2020-12-24 02:14:02.134|[2020-12-24 02:13:30, 2020-12-24 02:14:30]|
    |5.0        |3.0       |1.6        |0.2       |setosa    |2     |2020-12-24 02:14:02.134|[2020-12-24 02:13:30, 2020-12-24 02:14:30]|
    |6.3        |2.8       |5.1        |1.5       |virginica |0     |2020-12-24 02:14:02.134|[2020-12-24 02:13:30, 2020-12-24 02:14:30]|
    +-----------+----------+-----------+----------+----------+------+-----------------------+------------------------------------------+
    
    -------------------------------------------                                     
    Batch: 1
    -------------------------------------------
    +-----------+----------+-----------+----------+-------+------+------------+------------+
    |sepalLength|sepalWidth|petalLength|petalWidth|species|offset|receive_time|sliding_time|
    +-----------+----------+-----------+----------+-------+------+------------+------------+
    +-----------+----------+-----------+----------+-------+------+------------+------------+
    
    -------------------------------------------                                     
    Batch: 2
    -------------------------------------------
    +-----------+----------+-----------+----------+-------+------+------------+------------+
    |sepalLength|sepalWidth|petalLength|petalWidth|species|offset|receive_time|sliding_time|
    +-----------+----------+-----------+----------+-------+------+------------+------------+
    +-----------+----------+-----------+----------+-------+------+------------+------------+
    
    -------------------------------------------                                     
    Batch: 3
    -------------------------------------------
    +-----------+----------+-----------+----------+----------+------+-----------------------+------------------------------------------+
    |sepalLength|sepalWidth|petalLength|petalWidth|species   |offset|receive_time           |sliding_time                              |
    +-----------+----------+-----------+----------+----------+------+-----------------------+------------------------------------------+
    |6.7        |2.5       |5.8        |1.8       |virginica |19    |2020-12-24 02:14:40.004|[2020-12-24 02:14:30, 2020-12-24 02:15:30]|
    |5.8        |2.7       |4.1        |1.0       |versicolor|18    |2020-12-24 02:14:40.004|[2020-12-24 02:14:30, 2020-12-24 02:15:30]|
    +-----------+----------+-----------+----------+----------+------+-----------------------+------------------------------------------+
    
    -------------------------------------------                                     
    Batch: 4
    -------------------------------------------
    +-----------+----------+-----------+----------+----------+------+-----------------------+------------------------------------------+
    |sepalLength|sepalWidth|petalLength|petalWidth|species   |offset|receive_time           |sliding_time                              |
    +-----------+----------+-----------+----------+----------+------+-----------------------+------------------------------------------+
    |6.4        |2.8       |5.6        |2.2       |virginica |25    |2020-12-24 02:15:00.003|[2020-12-24 02:15:00, 2020-12-24 02:16:00]|
    |5.1        |3.8       |1.9        |0.4       |setosa    |26    |2020-12-24 02:15:00.003|[2020-12-24 02:15:00, 2020-12-24 02:16:00]|
    |5.1        |3.8       |1.9        |0.4       |setosa    |26    |2020-12-24 02:15:00.003|[2020-12-24 02:14:30, 2020-12-24 02:15:30]|
    |5.5        |2.3       |4.0        |1.3       |versicolor|24    |2020-12-24 02:15:00.003|[2020-12-24 02:15:00, 2020-12-24 02:16:00]|
    +-----------+----------+-----------+----------+----------+------+-----------------------+------------------------------------------+
    
Тут так же видим что в рамках каждого окна нет дубликатов. 


```python
stream.stop()
```


#OUTPUT MODES - считаем суммы
def console_output(df, freq, out_mode):
    return df.writeStream.format("console") \
        .trigger(processingTime='%s seconds' % freq ) \
        .options(truncate=False) \
        .option("checkpointLocation", "checkpoints/my_watermark_console_chk2") \
        .outputMode(out_mode) \
        .start()

count_orders = waterwarked_windowed_orders.groupBy("window_time").count()
#пишем только обновляющиеся записи
stream = console_output(count_orders , 20, "update")
stream.stop()

#пишем все  записи
stream = console_output(count_orders , 20, "complete")
stream.stop()

#пишем все записи только один раз
stream = console_output(count_orders , 20, "append") #один раз в конце вотермарки
stream.stop()

sliding_orders = waterwarked_sliding_orders.groupBy("sliding_time").count()
#наблюдаем за суммами в плавающем окне
stream = console_output(sliding_orders , 20, "update")
stream.stop()







##### Задание 2. Сджойнить стрим со статикой.


##### Задание 3. Сджойнить стрим со стримом.
